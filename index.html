<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Albero decisionale Cerved ‚Äì Discovery chiamata</title>
  <style>
    :root {
      --bg: #0b0d10; --panel: #12161b; --muted: #9aa4af; --text: #e9eef5; --accent: #5dd0ff; --accent-2: #9bffb0; --danger: #ff7a7a; --card: #0f1318; --chip: #1a2027; --border: #222934; --shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box} html,body{height:100%} body{margin:0;background:linear-gradient(180deg,var(--bg),#090b0f 60%);color:var(--text);font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji"}
    .wrap{max-width:1100px;margin:24px auto 56px;padding:0 16px}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:16px}
    .title{display:grid;gap:4px} .title h1{margin:0;font-size:22px;letter-spacing:.3px} .title p{margin:0;color:var(--muted);font-size:13px}
    .controls{display:flex;gap:8px;flex-wrap:wrap}
    button.btn{background:var(--chip);color:var(--text);border:1px solid var(--border);padding:10px 14px;border-radius:12px;cursor:pointer;font-weight:600;transition:.18s ease}
    button.btn:hover{transform:translateY(-1px);border-color:var(--accent);box-shadow:0 8px 20px rgba(93,208,255,.12)} button.btn:disabled{opacity:.45;cursor:not-allowed;transform:none;box-shadow:none}
    .grid{display:grid;grid-template-columns:1.25fr .75fr;gap:16px} @media(max-width:980px){.grid{grid-template-columns:1fr}}
    .panel{background:linear-gradient(180deg,var(--panel),#0f1419);border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow)}
    .question{padding:22px 22px 8px;border-bottom:1px solid var(--border)} .question small{color:var(--muted)} .qtext{font-size:18px;margin:4px 0 0}
    .options{padding:14px 18px 20px;display:grid;gap:10px}
    .opt{border:1px solid var(--border);background:var(--card);border-radius:14px;padding:14px 16px;cursor:pointer;display:flex;align-items:center;justify-content:space-between;gap:10px;transition:.18s ease}
    .opt:hover{border-color:var(--accent);box-shadow:0 8px 20px rgba(93,208,255,.1);transform:translateY(-1px)} .opt .hint{color:var(--muted);font-size:12px}
    .sidebar{padding:16px;display:grid;gap:16px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px} .card h3{margin:0 0 8px;font-size:14px;color:#dfe8f3;letter-spacing:.2px}
    .chips{display:flex;flex-wrap:wrap;gap:8px} .chip{background:var(--chip);border:1px solid var(--border);padding:6px 10px;border-radius:999px;font-size:12px;color:var(--text)}
    .breadcrumbs{display:flex;gap:6px;flex-wrap:wrap;padding:10px 16px;border-bottom:1px solid var(--border);color:var(--muted)} .crumb{display:inline-flex;gap:6px;align-items:center} .crumb a{color:var(--accent);text-decoration:none;font-size:13px}
    .footnote{color:var(--muted);font-size:12px;margin-top:4px}
    .solutions{display:grid;gap:8px} .solution{border:1px dashed var(--border);padding:10px 12px;border-radius:12px} .solution b{color:var(--accent-2)}
    .footer{text-align:center;color:var(--muted);font-size:12px;margin-top:12px}
    .status{padding:10px 16px;color:var(--muted);font-size:12px;border-bottom:1px solid var(--border)} .status b{color:var(--accent)}
    /* Modal Report */
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.45);padding:20px}
    .modal.open{display:flex}
    .modal .box{max-width:820px;width:100%;background:var(--panel);border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow)}
    .modal header{padding:14px 16px;border-bottom:1px solid var(--border)} .modal header h2{font-size:18px;margin:0}
    .modal .content{padding:16px}
    .report{white-space:pre-wrap;font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px;max-height:45vh;overflow:auto}
    .modal .actions{display:flex;gap:8px;justify-content:flex-end;padding:12px 16px 16px}
    /* Schema tools */
    .schema-tools{display:flex;gap:8px;flex-wrap:wrap}
    input[type=file]{display:none}
    label.file{background:var(--chip);border:1px solid var(--border);padding:10px 14px;border-radius:12px;cursor:pointer;font-weight:600}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="title">
        <h1>Albero decisionale ‚Äì Discovery chiamata (Cerved)</h1>
        <p>Clicca le risposte: il flusso prosegue alla domanda successiva e propone i servizi Cerved coerenti.</p>
      </div>
      <div class="controls">
        <button class="btn" id="backBtn" disabled>‚óÄÔ∏é Indietro</button>
        <button class="btn" id="restartBtn">‚ü≤ Ricomincia</button>
        <button class="btn" id="endNowBtn">‚úì Termina ora</button>
        <button class="btn" id="reportBtn" disabled>üìù Genera report</button>
        <button class="btn" id="mapBtn">‚ò∞ Mappa domande</button>
        <div class="schema-tools">
          <button class="btn" id="reloadSchema">‚Üª Ricarica albero</button>
          <label class="file" for="uploadSchema">‚§¥Ô∏é Carica JSON</label>
          <input type="file" id="uploadSchema" accept="application/json" />
          <button class="btn" id="downloadSchema">‚¨áÔ∏é Scarica schema</button>
        </div>
      </div>
      </div>
    </header>

    <div class="grid">
      <section class="panel" id="qaPanel">
        <div class="breadcrumbs" id="breadcrumbs"></div>
        <div class="status" id="status">Schema: <b>caricamento‚Ä¶</b></div>
        <div class="question">
          <small>Domanda corrente</small>
          <div class="qtext" id="qtext"></div>
        </div>
        <div class="options" id="options"></div>
      </section>

      <aside class="sidebar">
        <div class="card">
          <h3>Soluzioni suggerite (dinamiche)</h3>
          <div class="solutions" id="solutions"></div>
          <div class="footnote">Le proposte si aggiornano in base al percorso scelto.</div>
        </div>
        <div class="card">
          <h3>Percorso</h3>
          <div class="chips" id="pathChips"></div>
        </div>
        <div class="footer">¬© Flow builder per chiamate discovery ‚Äì Cerved</div>
      </aside>
    </div>
  </div>

  <!-- Modal Report -->
  <div class="modal" id="reportModal" aria-hidden="true">
    <div class="box">
      <header>
        <h2>Report sintetico azienda</h2>
      </header>
      <div class="content">
        <div class="report" id="reportText"></div>
      </div>
      <div class="actions">
        <button class="btn" id="copyReport">Copia</button>
        <button class="btn" id="downloadReport">Scarica .txt</button>
        <button class="btn" id="downloadPDF">Esporta PDF</button>
        <button class="btn" id="closeReport">Chiudi</button>
      </div>
    </div>
  </div>

  <script>
    // === CARICAMENTO SCHEMA DINAMICO ===
    let NODES = {};               // popola lo schema
    let RAW_SCHEMA_TEXT = '';     // testo originale per download

    const statusEl = document.getElementById('status');

    async function loadSchemaFromUrl(url = 'albero.json') {
      setStatus('caricamento‚Ä¶');
      try {
        const res = await fetch(url + (url.includes('?') ? '' : ('?v=' + Date.now())));
        if (!res.ok) throw new Error('HTTP ' + res.status + ' su ' + url);
        const text = await res.text();
        // debug: mostra qualche carattere iniziale se fallisce il parse
        try {
          const data = JSON.parse(text);
          NODES = data;
          RAW_SCHEMA_TEXT = JSON.stringify(data, null, 2);
          setStatus('caricato da ' + url);
          initOrRender(true);
        } catch (parseErr) {
          console.error('JSON parse error:', parseErr, text.slice(0, 200));
          throw new Error('Formato JSON non valido in ' + url + ' ‚Üí ' + parseErr.message);
        }
      } catch (e) {
        console.error('Schema load error:', e);
        setStatus('errore: ' + (e?.message || 'impossibile caricare lo schema')); 
        // fallback demo minimal
        NODES = demoSchema();
        RAW_SCHEMA_TEXT = JSON.stringify(NODES, null, 2);
        initOrRender(true);
      }
    } catch (e) { lastErr = e; }
      }
      setStatus('errore: impossibile caricare lo schema (' + (lastErr?.message||'') + '). Carica un JSON o usa lo schema demo.');
      NODES = demoSchema();
      RAW_SCHEMA_TEXT = JSON.stringify(NODES, null, 2);
      initOrRender(true);
    } catch (e) {
        setStatus('errore: non trovo "' + url + '". Carica un JSON o usa lo schema di esempio.');
        NODES = demoSchema();
        RAW_SCHEMA_TEXT = JSON.stringify(NODES, null, 2);
        initOrRender(true);
      }
    }

    function setStatus(text){ statusEl.innerHTML = 'Schema: <b>' + text + '</b>'; }

    function demoSchema(){
      return {
        "start": {"id":"start","text":"Qual √® la tipologia prevalente dei vostri clienti?","options":[
          {"label":"Grandi imprese","next":"geo","addSolutions":["Report Cerved","Pro Web"],"addTags":["Tipologia: Grandi"]},
          {"label":"PMI / Micro","next":"geo","addSolutions":["CCS"],"addTags":["Tipologia: PMI/Micro"]},
          {"label":"Altro","next":"geo","promptNote":true}
        ]},
        "geo": {"id":"geo","text":"La vostra clientela √® prevalentemente‚Ä¶","options":[
          {"label":"Italia","next":"acq","addSolutions":["Powerbiz","Marketing Intelligence"],"addTags":["Mercato: Italia"]},
          {"label":"Estero","next":"acq","addSolutions":["Atoka estero"],"addTags":["Mercato: Estero"]}
        ]},
        "acq": {"id":"acq","text":"Come individuate nuovi clienti o mercati?","options":[
          {"label":"Passaparola","next":null,"addSolutions":["Atoka","Marketing Intelligence"]},
          {"label":"Dati strutturati","next":null,"addSolutions":["API Cerved"]}
        ]}
      };
    }

    // === STATO ===
    const state = { stack: ['start'], answers: [], pathLabels: [], solutions: new Map() };
    function currentNode() { return NODES[state.stack[state.stack.length - 1]]; }

    // === INFO PRODOTTI (descrizione + perch√©) ===
    $1
      'Atoka': { desc: 'Piattaforma per prospecting, segmentazione e lead generation su imprese italiane/estere con filtri avanzati.', why: 'Utile per ampliare pipeline e qualificare target in modo data-driven.' },
      'Atoka (prospezione + add-on estero se serve)': { desc: 'Prospezione su Italia con estensione dati esteri quando necessario.', why: 'Copertura mista Italia/estero con continuit√† di filtri e arricchimento.' },
      'Atoka con add-on estero': { desc: 'Estensione per reperire dati e contatti su aziende estere (focus Europa).', why: 'Necessaria quando la clientela √® prevalentemente estera.' },
      'Atoka ‚Äì add-on estero (EU)': { desc: 'Modulo per prospecting su aziende europee con criteri simili all‚ÄôItalia.', why: 'Allinea i criteri di segmentazione al contesto UE.' },
      'Atoka estero': { desc: 'Prospezione e segmentazione su mercati esteri extra-UE.', why: 'Quando i target principali sono fuori dall‚ÄôUE.' },
      'Marketing Intelligence': { desc: 'Analisi di mercato, cluster e potenziale; supporto a piani commerciali e territori/settori.', why: 'Per scegliere dove investire e con quale priorit√†.' },
      'Powerbiz': { desc: 'Cruscotti commerciali su imprese italiane per mappare clienti/prospect e performance territoriali.', why: 'Per presidiare il mercato domestico con KPI fruibili.' },
      'Pro Web': { desc: 'Portale per visure, bilanci, assetti societari, eventi negativi/positivi e indicatori chiave.', why: 'Per qualificare partner e ridurre rischi informativi.' },
      'Report Cerved': { desc: 'Report completi sull‚Äôaffidabilit√† di controparti con indicatori economico-finanziari e sintetici.', why: 'Per decisioni strutturate su clienti/fornitori.' },
      'Rating & Affidabilit√†': { desc: 'Indicatori sintetici di solidit√† e rischio, utili per policy e plafond.', why: 'Per standardizzare valutazioni e guidare limiti di esposizione.' },
      'Cerved Credit Score (CCS)': { desc: 'Score di rischio credito per screening e monitoraggio del portafoglio.', why: 'Per prevenire insoluti e impostare soglie decisionali.' },
      'Credit Risk Management': { desc: 'Metodologie e workflow per governare il rischio credito (policy, processi, KPI).', why: 'Per strutturare governance, ridurre DSO e perdite.' },
      'Monitoring & Alert': { desc: 'Sorveglianza continua su clienti/fornitori con notifiche su cambi eventi/indicatori.', why: 'Per intervenire tempestivamente su segnali di deterioramento.' },
      'DAS (Document Acquisition System)': { desc: 'Raccolta automatizzata di documenti ufficiali (visure, bilanci, protesti).', why: 'Per velocizzare compliance, gare e onboarding.' },
      'CRM enrichment (API Cerved)': { desc: 'API per arricchire CRM/ERP con anagrafiche, codifiche e indicatori.', why: 'Per integrare i dati nei processi operativi.' },
      'Integrazione score Cerved': { desc: 'Utilizzo degli score Cerved dentro processi e tool interni/assicurativi.', why: 'Per uniformare le decisioni al rischio reale.' },
      'Visure/Report internazionali': { desc: 'Accesso a informazioni societarie e creditizie extra-UE.', why: 'Per qualificare partner non UE con fonti certificate.' },
      'Sessione consulenziale Cerved': { desc: 'Assessment personalizzato quando il caso √® atipico o complesso.', why: 'Per definire un piano su misura prima della demo.' },
      'Analisi personalizzata mercato/credito': { desc: 'Studio mirato su settore/portafoglio con raccomandazioni operative.', why: 'Per massimizzare ROI delle iniziative proposte.' },
      'Policy integrate con CCS': { desc: 'Allineamento score Cerved con assicurazioni/factoring.', why: 'Per coerenza tra coperture, limiti e allarmi.' },
      'Dashboard competitive': { desc: 'Monitor continuo dei competitor e posizionamento.', why: 'Per decisioni basate su dati nel go-to-market.' },
      'Atoka (segmentazione)': { desc: 'Segmentazione target e scoring commerciale multivariato.', why: 'Per migliorare resa di campagne e field sales.' },
      'Reportistica': { desc: 'Produzione periodica di report su portafoglio e rischi.', why: 'Per governance e condivisione interna.' },
      'Market/Competitive Intelligence': { desc: 'Dataset e analisi per conoscere il mercato e i concorrenti.', why: 'Per definire strategie di posizionamento e quote.' },
      'Benchmark settoriali': { desc: 'Indicatori comparati del settore e dei peer.', why: 'Per confrontare performance e margini rispetto al mercato.' },
      'Analisi comparativa avanzata': { desc: 'Confronto multi-criterio su peer selezionati.', why: 'Per individuare gap e opportunit√† specifiche.' },
      'Cerca il Bando': { desc: 'Ricerca e alert su bandi e gare rilevanti per il business.', why: 'Per intercettare opportunit√† di vendita e finanziamento.' }
    $2

    // === RENDER ===
    const qtextEl = document.getElementById('qtext');
    const optionsEl = document.getElementById('options');
    const backBtn = document.getElementById('backBtn');
    const restartBtn = document.getElementById('restartBtn');
    const endNowBtn = document.getElementById('endNowBtn');
    const reportBtn = document.getElementById('reportBtn');
    const mapBtn = document.getElementById('mapBtn');
    const solutionsEl = document.getElementById('solutions');
    const pathChipsEl = document.getElementById('pathChips');
    const breadcrumbsEl = document.getElementById('breadcrumbs');

    const reportModal = document.getElementById('reportModal');
    const reportText = document.getElementById('reportText');
    const copyReport = document.getElementById('copyReport');
    const downloadReport = document.getElementById('downloadReport');
    const downloadPDF = document.getElementById('downloadPDF');
    const closeReport = document.getElementById('closeReport');

    const mapModal = document.getElementById('mapModal');
    const mapList = document.getElementById('mapList');
    const mapSearch = document.getElementById('mapSearch');
    const closeMap = document.getElementById('closeMap');

    function render() {
      const node = currentNode();
      if (!node) { qtextEl.textContent = 'Nodo mancante. Controlla che l\'id esista nel JSON.'; optionsEl.innerHTML=''; return; }
      qtextEl.textContent = node.text || '(senza testo)';
      optionsEl.innerHTML = '';

      (node.options||[]).forEach((opt) => {
        const div = document.createElement('div');
        div.className = 'opt';
        const left = document.createElement('div');
        left.innerHTML = `<div>${opt.label || '(opzione)'}</div>`;
        const right = document.createElement('div');
        right.className = 'hint';
        right.textContent = opt.next ? 'continua ‚Üí' : 'conclusione';
        div.append(left, right);
        div.addEventListener('click', () => chooseOption(opt, node));
        optionsEl.appendChild(div);
      });

      backBtn.disabled = state.stack.length <= 1;
      reportBtn.disabled = state.answers.length === 0;

      // Breadcrumbs
      breadcrumbsEl.innerHTML = '';
      state.stack.forEach((nodeId, i) => {
        const span = document.createElement('span'); span.className = 'crumb';
        if (i < state.stack.length - 1) {
          const link = document.createElement('a');
          const label = (NODES[nodeId]?.text || '').slice(0,36) || nodeId;
          link.textContent = label + (label.length>=36 ? '‚Ä¶' : '');
          link.href = '#';
          link.addEventListener('click', (e) => { e.preventDefault(); jumpTo(i); });
          span.appendChild(link);
          const sep = document.createElement('span'); sep.textContent = '‚Ä∫'; sep.style.opacity = .6; span.appendChild(sep);
        } else {
          const cur = document.createElement('span'); cur.textContent = NODES[nodeId]?.text || nodeId; span.appendChild(cur);
        }
        breadcrumbsEl.appendChild(span);
      });

      // Path chips
      pathChipsEl.innerHTML = '';
      state.pathLabels.forEach((lbl) => { const c = document.createElement('span'); c.className='chip'; c.textContent = lbl; pathChipsEl.appendChild(c); });

      // Solutions ‚Äì sorted by weight desc
      const solutions = Array.from(state.solutions.entries()).sort((a,b) => b[1]-a[1]);
      solutionsEl.innerHTML = '';
      if (!solutions.length) { const empty = document.createElement('div'); empty.className = 'footnote'; empty.textContent = 'Nessuna proposta ancora: inizia a cliccare le risposte.'; solutionsEl.appendChild(empty); }
      else { solutions.forEach(([name, weight]) => { const row = document.createElement('div'); row.className='solution'; row.innerHTML = `<b>${name}</b><div class=\"footnote\">pertinenza √ó${weight}</div>`; solutionsEl.appendChild(row); }); }
    }

    function chooseOption(opt, node) {
      let note = '';
      if (opt.promptNote) {
        note = window.prompt('Specifica brevemente (verr√† messo nel report):', '') || '';
        if (note.trim()) state.pathLabels.push('Nota: ' + note.trim());
      }
      state.answers.push({ q: node.text || node.id, a: note ? `${opt.label} ‚Äì ${note}` : (opt.label||'') });
      (opt.addTags||[]).forEach(t => state.pathLabels.push(t));
      (opt.addSolutions||[]).forEach(s => state.solutions.set(s, (state.solutions.get(s) || 0) + 1));

      if (opt.next) { state.stack.push(opt.next); render(); }
      else { openReport(); }
    }

    function jumpTo(index) {
      state.stack = state.stack.slice(0, index + 1);
      state.answers = state.answers.slice(0, index);
      state.pathLabels = []; state.solutions = new Map();
      render();
    }

    backBtn.addEventListener('click', () => {
      if (state.stack.length > 1) { state.stack.pop(); state.answers.pop(); state.pathLabels=[]; state.solutions=new Map(); render(); }
    });
    restartBtn.addEventListener('click', () => { state.stack=['start']; state.answers=[]; state.pathLabels=[]; state.solutions=new Map(); closeReport(); render(); });

    // Termine intervista manuale
    endNowBtn.addEventListener('click', () => { openReport(true); });

    // === REPORT ===
    reportBtn.addEventListener('click', () => openReport());

    function buildProductSection(){
      const solutions = Array.from(state.solutions.entries()).sort((a,b)=>b[1]-a[1]);
      if (!solutions.length) return 'Nessun prodotto consigliato: l\'intervista √® troppo breve.
';
      const lines = [];
      solutions.forEach(([name, weight]) => {
        const info = SOLUTION_INFO[name] || {};
        // motivazione semplice in base ai tag scelti
        const whyFromPath = inferReason(name);
        lines.push(`‚Ä¢ ${name} (pertinenza √ó${weight})`);
        if (info.desc) lines.push(`  ‚Äì Cos'√®: ${info.desc}`);
        if (info.why || whyFromPath) lines.push(`  ‚Äì Perch√© ora: ${whyFromPath || info.why}`);
      });
      return lines.join('
');
    }

    function inferReason(name){
      const tags = state.pathLabels.join(' | ');
      if (/Mercato: Estero/.test(tags) && /Atoka|internazionali|estero/i.test(name)) return 'clientela estera ‚Üí serve copertura e segmentazione fuori Italia.';
      if (/Mercato: Italia/.test(tags) && /Powerbiz/.test(name)) return 'focalizzazione sul mercato domestico ‚Üí cruscotti Italia.';
      if (/Acquisizione:/.test(tags) && /Atoka|Marketing Intelligence|segmentazione/i.test(name)) return 'priorit√† su nuova pipeline e targettizzazione.';
      if (/CRM: No|CRM: S√¨ \(non integrato\)/.test(tags) && /API|enrichment/i.test(name)) return 'integrazione/arricchimento dati nel CRM per operativit√†.';
      if (/Valutazione: Esperienza/.test(tags) && /Report|Pro Web/.test(name)) return 'standardizzare la qualificazione oltre all\'esperienza.';
      if (/Credito: Non monitorato/.test(tags) && /CCS|Credit Risk|Monitoring/i.test(name)) return 'mancato monitoraggio del rischio ‚Üí introdurre score e allarmi.';
      if (/Competitor:/.test(tags) && /Market|Benchmark|Dashboard competitive/.test(name)) return 'necessit√† di confronto strutturato con il mercato.';
      if (/Attrito: Documenti/.test(tags) && /DAS/.test(name)) return 'colli di bottiglia su documenti ‚Üí automazione acquisizione.';
      if (/Attrito: Qualifica/.test(tags) && /Report|Pro Web|Monitoring/.test(name)) return 'qualifica debole ‚Üí documenti e sorveglianza costante.';
      if (/Attrito: Credito/.test(tags) && /CCS|Monitoring|Credit Risk/.test(name)) return 'problemi di incasso ‚Üí score, policy e alert.';
      return '';
    }

    function buildReportText(manual=false){
      const dt = new Date().toLocaleString('it-IT');
      const lines = [];
      lines.push('üß≠ Responso intervista ‚Äì Discovery Cerved');
      lines.push('Data: ' + dt + (manual ? ' (terminata manualmente)' : ''));
      lines.push('');
      lines.push('üìå Prodotti consigliati (con spiegazione)');
      lines.push(buildProductSection());
      lines.push('');
      lines.push('‚Äî ‚Äî ‚Äî');
      lines.push('');
      lines.push('üß© Risposte raccolte');
      state.answers.forEach((r,i)=>lines.push(`${i+1}. ${r.q}
   ‚Üí ${r.a}`));
      if (state.pathLabels.length){ lines.push(''); lines.push('üè∑Ô∏è Tag / Note'); state.pathLabels.forEach(t=>lines.push('‚Ä¢ '+t)); }
      return lines.join('
');
    }

    function openReport(manual=false){ reportText.textContent = buildReportText(manual); reportModal.classList.add('open'); reportModal.setAttribute('aria-hidden','false'); }
    function closeReport(){ reportModal.classList.remove('open'); reportModal.setAttribute('aria-hidden','true'); }
    copyReport.addEventListener('click', async ()=>{ try{ await navigator.clipboard.writeText(reportText.textContent); copyReport.textContent='Copiato!'; setTimeout(()=>copyReport.textContent='Copia',1200);}catch(e){} });
    downloadReport.addEventListener('click', () => {
      const blob=new Blob([reportText.textContent],{type:'text/plain;charset=utf-8'});
      const url=URL.createObjectURL(blob);
      const a=document.createElement('a'); a.href=url; a.download='Responso_Discovery_Cerved.txt';
      document.body.appendChild(a); a.click(); a.remove();
      setTimeout(()=>URL.revokeObjectURL(url),500);
    });

    // PDF via finestra di stampa con layout dedicato
    downloadPDF.addEventListener('click', () => {
      const win = window.open('', '_blank');
      const css = `
        <style>
          body{font:14px/1.4 system-ui, Segoe UI, Roboto, Arial; color:#111; padding:24px}
          h1{font-size:20px;margin:0 0 12px}
          .meta{color:#444;margin-bottom:16px}
          pre{white-space:pre-wrap;background:#fafafa;border:1px solid #eee;padding:12px;border-radius:8px}
          @page{margin:16mm}
        </style>`;
      const dt = new Date().toLocaleString('it-IT');
      win.document.write('<!DOCTYPE html><html><head><meta charset="utf-8"><title>Responso Discovery Cerved</title>'+css+'</head><body>');
      win.document.write('<h1>Responso Discovery Cerved</h1>');
      win.document.write('<div class="meta">Generato: '+dt+'</div>');
      win.document.write('<pre>'+reportText.textContent.replace(/[&<>]/g, s=>({"&":"&amp;","<":"&lt;",">":"&gt;"}[s]))+'</pre>');
      win.document.write('</body></html>');
      win.document.close();
      win.focus();
      win.print();
    }); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='Responso_Discovery_Cerved.txt'; document.body.appendChild(a); a.click(); a.remove(); setTimeout(()=>URL.revokeObjectURL(url),500); });
    closeReport.addEventListener('click', closeReport);

    // === MAPPA DOMANDE ===
    mapBtn.addEventListener('click', openMap);
    closeMap.addEventListener('click', () => mapModal.classList.remove('open'));
    mapSearch.addEventListener('input', filterMap);

    function openMap(){
      buildMapList();
      mapModal.classList.add('open');
    }
    function buildMapList(){
      const values = Object.values(NODES||{});
      mapList.innerHTML='';
      values.forEach(node => {
        const box = document.createElement('div');
        box.className = 'solution';
        const count = (node.options||[]).length;
        box.innerHTML = `<b>${node.id}</b> ‚Äî ${node.text || '(senza testo)'}<div class="footnote">opzioni: ${count}</div>`;
        box.style.cursor = 'pointer';
        box.addEventListener('click', ()=>{ state.stack=[node.id]; state.answers=[]; state.pathLabels=[]; state.solutions=new Map(); render(); mapModal.classList.remove('open'); });
        mapList.appendChild(box);
      });
    }
    function filterMap(){
      const q = (mapSearch.value||'').toLowerCase();
      const items = Array.from(mapList.children);
      items.forEach(el => { const t = el.textContent.toLowerCase(); el.style.display = t.includes(q) ? '' : 'none'; });
    }

    // === SCHEMA TOOLS ===
    document.getElementById('reloadSchema').addEventListener('click', ()=> loadSchemaFromUrl('albero.json'));
    document.getElementById('downloadSchema').addEventListener('click', ()=>{
      const blob = new Blob([RAW_SCHEMA_TEXT || JSON.stringify(NODES,null,2)], {type:'application/json;charset=utf-8'});
      const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href=url; a.download='albero.json'; document.body.appendChild(a); a.click(); a.remove(); setTimeout(()=>URL.revokeObjectURL(url),500);
    });
    document.getElementById('uploadSchema').addEventListener('change', (e)=>{
      const file = e.target.files?.[0]; if(!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        try { const data = JSON.parse(reader.result); NODES = data; RAW_SCHEMA_TEXT = JSON.stringify(data,null,2); setStatus('caricato da file locale'); initOrRender(true); }
        catch(err){ setStatus('errore parsing JSON: ' + err.message); }
      };
      reader.readAsText(file);
    });

    function initOrRender(reset=false){ if(reset){ state.stack=['start']; state.answers=[]; state.pathLabels=[]; state.solutions=new Map(); } render(); }

    // Avvio: prova a leggere ?schema=... dalla URL, altrimenti albero.json
    const urlParams = new URLSearchParams(location.search);
    const schemaParam = urlParams.get('schema');
    loadSchemaFromUrl(schemaParam || 'albero.json');
  </script>
  <!-- Modal Mappa Domande -->
  <div class="modal" id="mapModal" aria-hidden="true">
    <div class="box">
      <header>
        <h2>Tutte le domande disponibili</h2>
      </header>
      <div class="content">
        <input id="mapSearch" placeholder="Cerca testo o id‚Ä¶" style="width:100%;padding:10px;border-radius:10px;border:1px solid var(--border);background:var(--card);color:var(--text);margin-bottom:10px" />
        <div id="mapList" style="display:grid;gap:8px;max-height:50vh;overflow:auto"></div>
      </div>
      <div class="actions">
        <button class="btn" id="closeMap">Chiudi</button>
      </div>
    </div>
  </div>

  </body>
</html>
